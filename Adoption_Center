#include <iostream>
#include <vector>
#include <memory>
#include <fstream>
#include <sstream>
#include <algorithm>
#include <limits>  // For numeric_limits

using namespace std;

class Animal {
protected:
    string name;
    int age;
    string breed;

public:
    Animal(const string& n, int a, const string& b) : name(n), age(a), breed(b) {}

    virtual void display() const {
        cout << "Name: " << name << ", Age: " << age << ", Breed: " << breed;
    }

    virtual string getType() const = 0;

    virtual string toFileString() const {
        return getType() + "," + name + "," + to_string(age) + "," + breed;
    }

    string getBreed() const { return breed; }
};

class Dog : public Animal {
public:
    Dog(const string& n, int a, const string& b) : Animal(n, a, b) {}

    void display() const override {
        cout << "[Dog] ";
        Animal::display();
    }

    string getType() const override {
        return "dog";
    }
};

class Cat : public Animal {
public:
    Cat(const string& n, int a, const string& b) : Animal(n, a, b) {}

    void display() const override {
        cout << "[Cat] ";
        Animal::display();
    }

    string getType() const override {
        return "cat";
    }
};

class AdoptionCenter {
private:
    vector<shared_ptr<Animal>> animals;

    int getValidatedIndex(int max) {
        int index;
        while (true) {
            cin >> index;
            if (!cin.fail() && index >= 1 && index <= max) {
                cin.ignore(numeric_limits<streamsize>::max(), '\n'); // clear rest of line
                return index - 1;
            }
            cout << "Invalid number. Please enter a valid option (1 to " << max << "): ";
            cin.clear();
            cin.ignore(numeric_limits<streamsize>::max(), '\n');
        }
    }

    int getValidatedAge() {
        int age;
        while (true) {
            cin >> age;
            if (!cin.fail() && age >= 0 && age <= 100) {
                cin.ignore(numeric_limits<streamsize>::max(), '\n');
                return age;
            }
            cout << "Enter a valid age (0-100): ";
            cin.clear();
            cin.ignore(numeric_limits<streamsize>::max(), '\n');
        }
    }

    string getNonEmptyLine(const string& prompt) {
        string input;
        cout << prompt;
        getline(cin, input);
        while (input.empty()) {
            cout << "Input cannot be empty. " << prompt;
            getline(cin, input);
        }
        return input;
    }

public:
    void addAnimal() {
        string type;
        cout << "Enter type (dog/cat): ";
        getline(cin, type);

        // Convert to lowercase
        transform(type.begin(), type.end(), type.begin(), ::tolower);

        if (type != "dog" && type != "cat") {
            cout << "Invalid animal type.\n";
            return;
        }

        string name = getNonEmptyLine("Enter name: ");
        cout << "Enter age: ";
        int age = getValidatedAge();
        string breed = getNonEmptyLine("Enter breed: ");

        if (type == "dog")
            animals.push_back(make_shared<Dog>(name, age, breed));
        else
            animals.push_back(make_shared<Cat>(name, age, breed));

        cout << "âœ… Animal added successfully.\n";
    }

    void listAnimals() const {
        if (animals.empty()) {
            cout << "No animals available.\n";
            return;
        }

        cout << "\nAvailable Animals:\n";
        for (size_t i = 0; i < animals.size(); ++i) {
            cout << i + 1 << ". ";
            animals[i]->display();
            cout << "\n";
        }
    }

    void adoptAnimal() {
        if (animals.empty()) {
            cout << "No animals available to adopt.\n";
            return;
        }

        listAnimals();
        cout << "Enter the number of the animal to adopt: ";
        int index = getValidatedIndex((int)animals.size());

        cout << "You adopted: ";
        animals[index]->display();
        cout << "\nâœ… Adoption successful.\n";

        animals.erase(animals.begin() + index);
    }

    void saveToFile(const string& filename) const {
        ofstream out(filename);
        if (!out) {
            cout << "Failed to open file for writing.\n";
            return;
        }

        for (const auto& a : animals) {
            out << a->toFileString() << "\n";
        }

        cout << "âœ… Data saved to " << filename << "\n";
    }

    void loadFromFile(const string& filename) {
        ifstream in(filename);
        if (!in) {
            cout << "No previous data file found.\n";
            return;
        }

        animals.clear();
        string line;

        while (getline(in, line)) {
            istringstream ss(line);
            string type, name, ageStr, breed;
            getline(ss, type, ',');
            getline(ss, name, ',');
            getline(ss, ageStr, ',');
            getline(ss, breed);

            int age = stoi(ageStr);

            if (type == "dog")
                animals.push_back(make_shared<Dog>(name, age, breed));
            else if (type == "cat")
                animals.push_back(make_shared<Cat>(name, age, breed));
        }

        cout << "âœ… Data loaded from " << filename << "\n";
    }

    void searchByBreed() const {
        if (animals.empty()) {
            cout << "No animals available.\n";
            return;
        }

        string breed;
        cout << "Enter breed to search: ";
        getline(cin, breed);

        bool found = false;
        for (const auto& a : animals) {
            if (a->getBreed() == breed) {
                a->display();
                cout << "\n";
                found = true;
            }
        }

        if (!found)
            cout << "No animals found with that breed.\n";
    }
};

int main() {
    AdoptionCenter center;
    const string filename = "pets.txt";

    center.loadFromFile(filename);

    int choice;
    do {
        cout << "\nðŸ¾ Pet Adoption Center Menu:\n";
        cout << "1. Add Animal\n";
        cout << "2. List Animals\n";
        cout << "3. Adopt Animal\n";
        cout << "4. Save to File\n";
        cout << "5. Load from File\n";
        cout << "6. Search by Breed\n";
        cout << "0. Exit\n";
        cout << "Enter your choice: ";

        cin >> choice;
        if (cin.fail()) {
            cin.clear();
            cin.ignore(numeric_limits<streamsize>::max(), '\n');
            cout << "Invalid input. Please enter a number from 0 to 6.\n";
            continue;
        }
        cin.ignore(numeric_limits<streamsize>::max(), '\n'); // clear newline after number input

        switch (choice) {
            case 1: center.addAnimal(); break;
            case 2: center.listAnimals(); break;
            case 3: center.adoptAnimal(); break;
            case 4: center.saveToFile(filename); break;
            case 5: center.loadFromFile(filename); break;
            case 6: center.searchByBreed(); break;
            case 0: cout << "Goodbye!\n"; break;
            default: cout << "Invalid choice. Try again.\n";
        }

    } while (choice != 0);

    return 0;
}

